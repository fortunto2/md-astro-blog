---
import { fetchPage, getCurrentDomain, generateDefaultHeader } from '../lib/md.ts';
import '../styles/global.css';

const host = Astro.request.headers.get('host') || '';
const url = new URL(Astro.request.url);
const domainOverride = url.searchParams.get('domain');
const currentDomain = domainOverride || getCurrentDomain(host);
const env = Astro.locals?.cloudflare?.env ?? Astro.locals?.runtime?.env;

const query = url.searchParams.get('q') || '';

const [headerHtml, footerPartial] = await Promise.all([
  fetchPage('header', true, currentDomain, env, Astro.request),
  fetchPage('footer', true, currentDomain, env, Astro.request)
]);

// Use default header if not found
const finalHeaderHtml = headerHtml || generateDefaultHeader(host);

const getPrimaryDomain = (domain: string) => {
  const parts = domain.split('.');
  if (parts.length >= 2) {
    return parts.slice(-2).join('.');
  }
  return domain;
};

const fallbackFooter = (() => {
  if (!currentDomain) return null;
  const primaryDomain = getPrimaryDomain(currentDomain);
  const email = `info@${primaryDomain}`;
  return `<p><a href="mailto:${email}">${email}</a></p>`;
})();

const footerHtml = footerPartial || fallbackFooter;

const canonicalUrl = host.includes('localhost') || host.includes('127.0.0.1')
  ? `http://${host}/search`
  : `https://${host}/search`;

// Set cache headers
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=3600, stale-while-revalidate=86400');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search | Blog</title>
    <meta name="description" content="Search through blog notes" />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- OG tags -->
    <meta property="og:title" content="Search | Blog" />
    <meta property="og:description" content="Search through blog notes" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Search | Blog" />
    <meta name="twitter:description" content="Search through blog notes" />
  </head>
  
  <body>
    <div class="max-w-4xl mx-auto p-8">
      <!-- Header -->
      <header class="mb-6 pb-4 border-b-2 border-black">
        <Fragment set:html={finalHeaderHtml} />
      </header>

      <!-- Navigation -->
      <nav class="mb-6 text-sm">
        <a href="/">‚Üê Back to index</a>
      </nav>

      <!-- Main Content -->
      <main>
        <h1>üîç SEARCH</h1>

        <!-- Search Form -->
        <form id="searchForm" class="mb-8">
          <table>
            <tr>
              <td><strong>Search Query:</strong></td>
              <td>
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Enter search query..."
                  value={query}
                  autofocus
                  class="w-full p-2 border-2 border-black font-mono text-lg"
                />
              </td>
            </tr>
            <tr>
              <td><strong>Search Mode:</strong></td>
              <td>
                <label class="mr-4">
                  <input type="radio" name="mode" value="search" checked class="mr-1" />
                  üîç Regular Search
                </label>
                <label>
                  <input type="radio" name="mode" value="ai" class="mr-1" />
                  ü§ñ AI Search
                </label>
              </td>
            </tr>
            <tr>
              <td><strong>Action:</strong></td>
              <td>
                <button
                  type="submit"
                  id="searchButton"
                  class="px-6 py-3 bg-gray-200 border-2 border-black font-bold text-lg hover:bg-yellow-200 cursor-pointer"
                >
                  SEARCH
                </button>
              </td>
            </tr>
          </table>
        </form>

        <!-- Search Results -->
        <div id="searchResults">
          {query && (
            <div class="text-center py-8 border-2 border-black bg-gray-100 font-bold">
              Searching for "{query}"...
            </div>
          )}
        </div>
      </main>

      <!-- Footer -->
      {footerHtml && (
        <footer class="mt-12 pt-6 border-t-2 border-black text-sm">
          <Fragment set:html={footerHtml} />
        </footer>
      )}
    </div>

    <script>
      import { SearchPage } from '../scripts/searchPage.js';
      new SearchPage();
    </script>
  </body>
</html>