---
import { fetchNote, getCurrentDomain, fetchPage, generateDefaultHeader } from '../lib/md.ts';

const host = Astro.request.headers.get('host') || '';
const url = new URL(Astro.request.url);
const domainOverride = url.searchParams.get('domain');
const currentDomain = domainOverride || getCurrentDomain(host);
const env = Astro.locals?.cloudflare?.env ?? Astro.locals?.runtime?.env;

const [headerHtml, html, footerPartial] = await Promise.all([
  fetchPage('header', true, currentDomain, env, Astro.request),
  (async () => {
    const note = await fetchNote('index', currentDomain, env, Astro.request);
    return note?.html ?? null;
  })(),
  fetchPage('footer', true, currentDomain, env, Astro.request)
]);

if (!html) {
  throw new Error('Failed to fetch index content');
}

// Use default header if not found
const finalHeaderHtml = headerHtml || generateDefaultHeader(host);

const getPrimaryDomain = (domain: string) => {
  const parts = domain.split('.');
  if (parts.length >= 2) {
    return parts.slice(-2).join('.');
  }
  return domain;
};

const fallbackFooter = (() => {
  if (!currentDomain) return null;
  const primaryDomain = getPrimaryDomain(currentDomain);
  const email = `info@${primaryDomain}`;
  return `<p><a href="mailto:${email}">${email}</a></p>`;
})();

const footerHtml = footerPartial || fallbackFooter;

const canonicalUrl = host.includes('localhost') || host.includes('127.0.0.1')
  ? `http://${host}`
  : `https://${host}`;
---

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zettelkasten Blog</title>
    <meta name="description" content="Public notes and knowledge graph" />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href={canonicalUrl.endsWith('/') ? canonicalUrl : `${canonicalUrl}/`} />
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />

    <!-- OG tags -->
    <meta property="og:title" content="Zettelkasten Blog" />
    <meta property="og:description" content="Public notes and knowledge graph" />
    <meta property="og:type" content="website" />

    <style>
      body {
        max-width: 860px;
        margin: 0 auto;
        padding: 2rem;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        line-height: 1.55;
      }

      .prose {
        color: #333;
      }

      .prose h1 {
        color: #111;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
      }

      .prose a {
        color: #0066cc;
        text-decoration: none;
      }

      .prose a:hover {
        text-decoration: underline;
      }

      .prose ul {
        padding-left: 1.5rem;
      }

      .prose li {
        margin: 0.5rem 0;
      }

      .hljs {
        background: #f8f8f8;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <header class="domain-header">
      <Fragment set:html={finalHeaderHtml} />
    </header>
    <div class="prose">
      <Fragment set:html={html} />
    </div>
    {footerHtml && (
      <footer class="domain-footer">
        <Fragment set:html={footerHtml} />
      </footer>
    )}
  </body>
</html>
